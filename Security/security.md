# Полная Архитектура Безопасности Всей Инфраструктуры (SECURITY.md)

Документ описывает безопасность всей распределённой инфраструктуры из 6+
нод, включая публичную White Node, DMZ, внутренние сервисы, мониторинг,
логи, базы данных и маршрутизацию.

Это --- производственная модель уровня enterprise, соответствующая
требованиям:\
- Zero Trust\
- Network Segmentation\
- Defense-in-Depth\
- Secure Container Runtime\
- Auditing & Incident Detection\
- Secret Management\
- Compliance-ready infrastructure

------------------------------------------------------------------------

# 1. Основные цели безопасности

1.  **Защитить публичный сервер (White Node)** как единственную точку
    входа.
2.  **Полностью изолировать внутренние сервисы** и обеспечить
    сегментацию сети.
3.  **Защитить конфиденциальные данные и логи** (Telegram, приложения).
4.  **Защитить внутренний кластер** (PostgreSQL, Nginx, OpenSearch,
    FluentD).
5.  **Обеспечить мониторинг атак и аномалий**.
6.  **Управлять доступом, секретами, обновлениями, контейнерами**.
7.  **Минимизировать возможную зону компрометации**.

------------------------------------------------------------------------

# 2. Архитектура безопасности --- уровни защиты

## Уровень 1 --- Базовая защита (обязательная)

### 2.1. Сетевой периметр

-   DMZ для White Node\
-   Полная сегментация всех других нод\
-   Deny-all policy на всех нодах\
-   Разрешаются только специфичные порты:
    -   443 → White Node (Webhook)
    -   24224 → Логи (FD)
    -   10050 → Zabbix Agent
    -   DNS, NTP

Ни одна нода не имеет широкого доступа ко ВСЕМ другим --- только
точечные каналы.

### 2.2. SSH Hardening

-   PasswordAuthentication no\
-   ChallengeResponseAuthentication no\
-   PermitRootLogin no\
-   AllowUsers только твой админский пользователь\
-   SSH только с твоего IP\
-   fail2ban + port knocking (опционально)

### 2.3. TLS Hardening

-   TLS 1.2 / 1.3\
-   HSTS\
-   OCSP Stapling\
-   Сертификаты Let's Encrypt или собственной PKI\
-   Cipher suite без слабых шифров:\

```{=html}
<!-- -->
```
    EECDH+AESGCM:EDH+AESGCM:AES256+EECDH

### 2.4. Контейнерная безопасность

-   Cap-drop=ALL\
-   Read-only FS\
-   user: non-root\
-   memory / cpu / pid limits\
-   seccomp + AppArmor\
-   No-new-privileges

### 2.5. Анонимизация логов

На всех FluentD: - remove_keys: password, cookies, authorization\
- фильтр Telegram-месседжей (чтобы не утекли диалоги)

### 2.6. Обновления

-   только security обновления\
-   dnf-automatic\
-   автоматический мониторинг CVE (Wazuh)

------------------------------------------------------------------------

# 3. Уровень 2 --- Продвинутая защита (рекомендуется)

## 3.1. IDS / IPS

-   **Wazuh Agent** (рекомендуется)\
-   File integrity monitoring\
-   Process monitoring\
-   Rootkit detection\
-   Ранний детект подозрительных действий

## 3.2. VPN / Зашифрованная внутренняя сеть

-   WireGuard → Нода №3\
-   Весь внутренний трафик должен идти через зашифрованный туннель

## 3.3. SELinux

-   enforcing\
-   custom policy для Docker\
-   audit2allow при необходимости

## 3.4. Аудит и контроль событий

-   auditd для:
    -   ssh
    -   sudo
    -   system modifications
    -   изменения конфигов Docker
    -   Nginx конфигов\
    -   изменения бинарей

## 3.5. Сканеры безопасности

Еженедельно: - **Lynis** --- аудит ОС\
- **Trivy** --- аудит Docker образов\
- **Nmap** --- self-scan\
- **Wazuh** --- автоматическая корреляция событий

------------------------------------------------------------------------

# 4. Уровень 3 --- Максимальная защита (уровень банков/гос/корп)

## 4.1. Zero Trust Model

Принцип: **"Каждый сервис недоверен... всегда."**

Это означает: - Нет внутренней сети, в которую можно freely connect.\
- Каждое соединение должно быть либо: - подписано\
- авторизовано\
- разрешено по IP\
- ограничено по времени\
- туннелировано через VPN

Ни одна нода не должна видеть другую без явного разрешения.

## 4.2. WAF (Web Application Firewall)

-   ModSecurity\
-   OWASP Core Rule Set 3.3\
-   Защищает:
    -   SQLi\
    -   XSS\
    -   RCE\
    -   Path Traversal\
    -   Bad Bots\
    -   Scanners

## 4.3. Secret Management

HashiCorp Vault: - Хранение Telegram Token\
- Хранение паролей к БД\
- Хранение API ключей\
- Автоматическое ротация ключей

## 4.4. DDoS защита

На уровне Nginx: - rate limiting:

    limit_req zone=req_limit_per_ip burst=10 nodelay;

-   ban по user-agent сканеров\
-   fail2ban nginx bans\
-   (опционально) Cloudflare proxy

## 4.5. Полная изоляция White Node

White Node **не должна иметь возможность**: - обратиться к базе\
- обратиться к OpenSearch\
- обратиться к мониторингу\
- обратиться к nginx нодам напрямую

White Node может: - принимать входящие от Telegram\
- отправлять логи в Ноду №5\
- делать исходящие запросы в Telegram API\
- опционально → VPN к Ноде №3

------------------------------------------------------------------------

# 5. Безопасность внутренних нод (1--5)

## 5.1. Нода №1 (Database)

-   PostgreSQL внутри Docker --- только localhost\
-   private network (docker network)\
-   SELinux → container\
-   бэкапы зашифрованы\
-   доступ только с Ноды №3 (технический nginx)\
-   fail2ban на PostgreSQL не требуется (закрытый порт)

## 5.2. Нода №2 (Application Nginx)

-   Принимает только от внутренних сервисов\
-   never exposed to internet\
-   логирование → FluentD

## 5.3. Нода №3 (Technical Nginx)

-   Единственный шлюз между DMZ и внутренней сетью\
-   WireGuard endpoint\
-   API-gateway функции\
-   HMAC валидация запросов (опционально)

## 5.4. Нода №4--5 (Monitoring)

-   OpenSearch не должен быть доступен из DMZ\
-   Dashboard только по VPN\
-   FluentD Hub получает логи только от нод\
-   Zabbix agent → только outbound

------------------------------------------------------------------------

# 6. Управление пользователями и доступами

### Минимальный набор аккаунтов:

-   администратор (ты)\
-   Zabbix agent\
-   Vault agent\
-   FluentD agent\
-   Docker runtime user (для бота)

**Нет root входа ни на одной ноде.**

### Пароли:

-   длина 20+\
-   только key-based авторизация\
-   никаких ssh-password входов

### MFA (по желанию)

-   Google Authenticator + SSH\
-   TOTP + PAM

------------------------------------------------------------------------

# 7. Мониторинг Security событий

### Сбор с:

-   auditd\
-   ssh logs\
-   nginx\
-   container logs\
-   wazuh

### Все события → FluentD → OpenSearch → Grafana/Zabbix

Построить дашборды: - Успешные/неуспешные SSH попытки\
- HTTP 403/404 peaks\
- Brute-force patterns\
- Внезапные перезапуски сервисов

------------------------------------------------------------------------

# 8. Диаграмма полной модели безопасности

                                           INTERNET
                                               │
                                        Telegram Servers
                                               │
                                          HTTPS 443
                                               │
                                  ┌──────────────────────────┐
                                  │     WHITE NODE (DMZ)     │
                                  │  Nginx + Docker + WAF    │
                                  │  SELinux + Wazuh + FD    │
                                  └───────────┬──────────────┘
                                              │ Logs → 24224
                                              ▼
                                   ┌────────────────────┐
                                   │   Нода №5 (FD Hub) │
                                   └────────────────────┘
                                              │
                                              ▼
                                   ┌────────────────────┐
                                   │ Нода №4 (OpenSearch)│
                                   └────────────────────┘
                                              │
                                ┌─────────────┴─────────────┐
                                │                           │
                      ┌────────────────────┐      ┌────────────────────┐
                      │ Нода №3 (Tech Nginx│◄────►│ WireGuard VPN       │
                      └────────────────────┘      └────────────────────┘
                                │
                                ▼
                      ┌────────────────────┐
                      │ Нода №1 (Database) │
                      └────────────────────┘

------------------------------------------------------------------------

# 9. Итог

## Инфраструктура после внедрения:

-   Публичная нода защищена тройным периметром
-   Внутренние сервисы полностью изолированы
-   Логи безопасно собираются
-   Контейнеры защищены
-   Секреты не хранятся в конфиге
-   Атаки обнаруживаются автоматически
-   Сеть работает по Zero Trust принципам
-   Полная совместимость с твоим текущим стеком CentOS + Docker +
    FluentD + Zabbix + OpenSearch

------------------------------------------------------------------------

# 10. Готовые улучшения (по желанию)

Могу подготовить: - Ansible playbook для защиты всех нод\
- ModSecurity ruleset\
- Nginx конфиги\
- Docker-compose secure edition\
- WireGuard конфигурации\
- Vault integration\
- Wazuh серверную часть

Скажи --- соберу.
