# -------------------------------------------------------
# PostgreSQL main config file
# Generated by Ansible (DO NOT EDIT MANUALLY)
# -------------------------------------------------------
# -------------------------------------------------------
# Basic settings
port = {{ postgres_port }}
listen_addresses = '{{ postgres_listen }}'
max_connections = {{ postgres_max_connections }}
# -------------------------------------------------------
# Authentication & Encryption
password_encryption = '{{ postgres_password_encryption }}'
# -------------------------------------------------------
# Logging (Не смотря на фиксированные переменные в pgsql_common, здесь реализован "if..else" для устойивости шаблона к отсутсвию переменных)
log_destination = '{{ postgres_log_destination }}' 
logging_collector = {{ postgres_logging_collector }}
log_line_prefix = '{{ postgres_log_line_prefix }}'
log_directory = '{{ postgres_log_directory | default("pg_log") }}' # Если переменная задана, то вставь ее, иначе "pg_log" (if..else реализуется default)
log_filename = '{{ postgres_log_filename | default("postgresql-%Y-%m-%d_%H%M%S.log") }}'
log_rotation_age = '{{ postgres_log_rotation_age | default("1d") }}'
log_rotation_size = '{{ postgres_log_rotation_size | default("100MB") }}'
log_truncate_on_rotation = {{ postgres_log_truncate_on_rotation | default("on") }}
log_connections = {{ postgres_log_connections | default("on") }}
log_disconnections = {{ postgres_log_disconnections | default("on") }}
log_checkpoints = {{ postgres_log_checkpoints | default("on") }}
# Логировать только медленные запросы (>= N мс)
log_min_duration_statement = {{ postgres_log_min_duration_statement | default("200ms") }}
# -------------------------------------------------------
## Hardware
shared_buffers = {{ postgres_shared_buffers }}
work_mem = {{ postgres_work_mem }}
maintenance_work_mem = {{ postgres_maintenance_work_mem }}
effective_cache_size = {{ postgres_effective_cache_size }}
# -------------------------------------------------------
# Locale & timezone
timezone = '{{ postgres_timezone | default("Europe/Amsterdam") }}'
# -------------------------------------------------------
# Кодировки
# server_encoding = 'UTF8' # Задается на этапе initdb и read-only
client_encoding = 'UTF8'
# -------------------------------------------------------
# Локали (набор правил и настроек, определяющих региональные особенности для форматов дат, чисел, денег и сообщений)
lc_messages = '{{ postgres_lc_messages | default("en_US.UTF-8") }}'
lc_numeric  = '{{ postgres_lc_numeric  | default("en_US.UTF-8") }}'
lc_time     = '{{ postgres_lc_time     | default("en_US.UTF-8") }}'
lc_monetary = '{{ postgres_lc_monetary | default("en_US.UTF-8") }}'
# -------------------------------------------------------
# Custom parameters (optional)
# Пример в vars:
# postgres_custom_parameters:
#   log_min_duration_statement: 1000
#   shared_preload_libraries: "pg_stat_statements"
# -------------------------------------------------------
{% if postgres_custom_parameters is defined and postgres_custom_parameters %}
{% for key, value in postgres_custom_parameters.items() %}
{% if value is string %}
{{ key }} = '{{ value }}'
{% else %}
{{ key }} = {{ value }}
{% endif %}
{% endfor %}
{% endif %}
# -------------------------------------------------------
# SSL / TLS 
# Для локального pet-кластера можно держать postgres_ssl = false.
# Для включения SSL в vars:
#   postgres_ssl: true
#   postgres_ssl_cert: "/etc/postgresql/ssl/server.crt"
#   postgres_ssl_key:  "/etc/postgresql/ssl/server.key"
#   postgres_ssl_ca:   "/etc/postgresql/ssl/rootCA.crt"   # опционально
# -------------------------------------------------------
ssl = {% if postgres_ssl %}on{% else %}off{% endif %}

{% if postgres_ssl %}
ssl_cert_file = '{{ postgres_ssl_cert }}'
ssl_key_file  = '{{ postgres_ssl_key }}'
{% if postgres_ssl_ca is defined and postgres_ssl_ca %}
ssl_ca_file   = '{{ postgres_ssl_ca }}'
{% endif %}
{% endif %}