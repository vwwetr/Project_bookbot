---
# Установка PostgreSQL из стандартных репозиториев CentOS Stream 10
- name: Install PostgreSQL server and required packages
  # Нужен для: установки PostgreSQL-сервера, contrib-модулей и драйвера для Ansible-модулей PostgreSQL
  ansible.builtin.dnf:
    name: "{{ postgresql_packages }}"
    state: present

# Инициализация кластера БД (один раз)
- name: Initialize PostgreSQL DB cluster
  ansible.builtin.command:
    cmd: "postgresql-setup --initdb"
  args:
    # Файл PG_VERSION появляется только после успешного initdb
    creates: "{{ postgresql_data_dir }}/PG_VERSION"
  when: postgresql_initdb | bool
  # На CentOS/RHEL этот скрипт инициализации выполняет все необходимые действия
  # от имени пользователя postgres в нужной директории (по умолчанию /var/lib/pgsql/data).

# Развёртывание postgresql.conf
- name: Deploy postgresql.conf
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: "{{ postgresql_data_dir }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  notify:
    - Restart PostgreSQL
    - PostgreSQL healthcheck

# Развёртывание pg_hba.conf
- name: Deploy pg_hba.conf template
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: "{{ postgresql_data_dir }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  notify: 
  - Restart PostgreSQL
  - PostgreSQL healthcheck

# Запуск сервиса PostgreSQL и включение автозапуска
- name: Run PostgreSQL server and make it enable on boot
  ansible.builtin.service:
    name: "{{ postgresql_service_name }}"
    state: started
    enabled: true  # Флаг на автозапуск при развертывании
    daemon_reload: true